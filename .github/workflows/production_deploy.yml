name: Production Deploy

on:
  workflow_run:
    workflows: ["Production Test"]
    branches: [ master ]
    types:
      - completed

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------------------------------
      # STEP 1: Update Codebase
      # ----------------------------------------------------------------
      - name: 1. Pull Latest Code
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script_stop: true
          script: |
            cd ~/ssp
            echo "Pulling latest changes..."
            git pull origin master

      # ----------------------------------------------------------------
      # STEP 2: Backend Dependencies (Composer)
      # ----------------------------------------------------------------
      - name: 2. Install Backend Dependencies
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script_stop: true
          script: |
            cd ~/ssp
            echo "Installing Composer dependencies..."
            composer install --no-dev --optimize-autoloader --no-interaction

      - name: 3. Build Frontend Assets
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script_stop: true
          script: |
            cd ~/ssp
            echo "Installing ALL dependencies (including Vite)..."
            npm ci 
            
            echo "Building assets..."
            npm run build
            
            echo "Cleaning up dev dependencies..."
            npm prune --production

      - name: 4. Migrate & Optimize
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.DEPLOY_SERVER }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          script_stop: true
          script: |
            cd ~/ssp
            echo "Running migrations..."
            php artisan migrate

            echo "Clearing and optimizing caches..."
            php artisan optimize:clear
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            php artisan optimize

